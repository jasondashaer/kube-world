---
# Main Ansible Playbook for Raspberry Pi K3s Cluster Setup
# This playbook configures Pi hardware, installs K3s, and prepares for GitOps
#
# RELIABILITY NOTES:
# - Each play re-establishes connection to handle WiFi drops
# - Long-running tasks have explicit timeouts
# - Package operations are batched to avoid resource exhaustion

- name: Validate connectivity and gather facts
  hosts: k3s_cluster
  gather_facts: yes
  vars:
    ansible_ssh_timeout: 60
    ansible_command_timeout: 120
  tasks:
    - name: Display host information
      debug:
        msg: "Connected to {{ inventory_hostname }} ({{ ansible_host }})"

    - name: Verify network connectivity
      wait_for_connection:
        timeout: 60
      register: connection_check

    - name: Ensure WiFi power save is disabled (stability)
      shell: iw dev wlan0 set power_save off 2>/dev/null || true
      become: yes
      changed_when: false
      ignore_errors: yes

- name: Configure Raspberry Pi base system
  hosts: k3s_cluster
  become: yes
  gather_facts: no  # Already gathered above
  vars:
    ansible_ssh_timeout: 60
    required_packages:
      - curl
      - wget
      - git
      - jq
      - htop
      - iotop
      - vim
      - open-iscsi  # For Longhorn storage
      - nfs-common
      - util-linux  # For NVMe utilities
  
  tasks:
    - name: Re-verify connectivity before base configuration
      wait_for_connection:
        timeout: 30

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      retries: 3
      delay: 10
      register: apt_update
      until: apt_update is success

    - name: Upgrade all packages
      apt:
        upgrade: dist
      async: 600  # 10 minute timeout for upgrades
      poll: 30
      when: upgrade_packages | default(false)

    - name: Install required packages (batch 1 - essentials)
      apt:
        name:
          - curl
          - wget
          - git
          - jq
        state: present
      retries: 3
      delay: 10
      register: pkg_batch1
      until: pkg_batch1 is success

    - name: Install required packages (batch 2 - monitoring)
      apt:
        name:
          - htop
          - iotop
          - vim
        state: present
      retries: 3
      delay: 10
      register: pkg_batch2
      until: pkg_batch2 is success

    - name: Install required packages (batch 3 - storage)
      apt:
        name:
          - open-iscsi
          - nfs-common
          - util-linux
        state: present
      retries: 3
      delay: 10
      register: pkg_batch3
      until: pkg_batch3 is success

    - name: Set hostname
      hostname:
        name: "{{ node_name | default(inventory_hostname) }}"

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ node_name | default(inventory_hostname) }}"
        state: present

    - name: Configure kernel parameters for Kubernetes
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }
        - { key: 'vm.swappiness', value: '0' }

    - name: Ensure br_netfilter module is loaded
      modprobe:
        name: br_netfilter
        state: present

    - name: Persist br_netfilter module
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        line: br_netfilter
        create: yes

    - name: Disable swap
      command: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: Configure cgroup memory (Raspberry Pi specific)
      lineinfile:
        path: /boot/firmware/cmdline.txt
        regexp: '^(.*?)$'
        line: '\1 cgroup_memory=1 cgroup_enable=memory'
        backrefs: yes
      register: cgroup_config
      when: ansible_architecture == "aarch64"

    - name: Notify about required reboot
      debug:
        msg: "CGROUP CONFIG CHANGED - Reboot will be required"
      when: cgroup_config.changed | default(false)
      changed_when: true
      notify: reboot_if_required

  handlers:
    - name: reboot_if_required
      reboot:
        reboot_timeout: 300
        msg: "Rebooting for cgroup configuration"
        post_reboot_delay: 30
      listen: reboot_if_required

- name: Post-reboot connectivity verification
  hosts: k3s_cluster
  gather_facts: no
  tasks:
    - name: Wait for Pi to be reachable after any reboot
      wait_for_connection:
        timeout: 120
        delay: 10

    - name: Re-disable WiFi power save after reboot
      shell: iw dev wlan0 set power_save off 2>/dev/null || true
      become: yes
      changed_when: false
      ignore_errors: yes

- name: Configure NVMe storage (if present)
  hosts: k3s_cluster
  become: yes
  gather_facts: no
  tasks:
    - name: Re-verify connectivity before NVMe configuration
      wait_for_connection:
        timeout: 30

    - name: Check for NVMe devices
      shell: lsblk -d -o NAME,TYPE | grep nvme || true
      register: nvme_check
      changed_when: false

    - name: Configure NVMe storage
      when: nvme_check.stdout != ""
      block:
        - name: Create mount point for NVMe
          file:
            path: /mnt/nvme
            state: directory
            mode: '0755'

        - name: Check if NVMe is already formatted
          command: blkid /dev/nvme0n1p1
          register: nvme_formatted
          failed_when: false
          changed_when: false

        - name: Create partition on NVMe
          parted:
            device: /dev/nvme0n1
            number: 1
            state: present
            fs_type: ext4
          when: nvme_formatted.rc != 0

        - name: Format NVMe partition
          filesystem:
            fstype: ext4
            dev: /dev/nvme0n1p1
          when: nvme_formatted.rc != 0

        - name: Mount NVMe storage
          mount:
            path: /mnt/nvme
            src: /dev/nvme0n1p1
            fstype: ext4
            opts: defaults,noatime
            state: mounted

        - name: Create K8s storage directory on NVMe
          file:
            path: /mnt/nvme/k8s-storage
            state: directory
            mode: '0755'

- name: Install K3s on master nodes
  hosts: masters
  become: yes
  gather_facts: no
  vars:
    k3s_server_args: >-
      --cluster-init
      --disable=traefik
      --disable=servicelb
      --write-kubeconfig-mode=0644
      --tls-san={{ ansible_host }}
      --tls-san={{ node_name }}
      --node-label=node.kubernetes.io/role=master
      --node-label=topology.kubernetes.io/zone=edge
      --node-label=workload-type=iot
      --node-label=hardware=raspberry-pi-5
  
  tasks:
    - name: Pre-flight connectivity check before K3s install
      wait_for_connection:
        timeout: 30

    - name: Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_installed

    - name: Download K3s installer script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: '0755'
        timeout: 60
      register: k3s_download
      retries: 3
      delay: 10
      until: k3s_download is success
      when: not k3s_installed.stat.exists

    - name: Install K3s server
      shell: |
        INSTALL_K3S_VERSION={{ k3s_version }} \
        /tmp/k3s-install.sh server {{ k3s_server_args }}
      when: not k3s_installed.stat.exists
      async: 600
      poll: 15

    - name: Wait for K3s service to start
      systemd:
        name: k3s
        state: started
      register: k3s_service
      retries: 5
      delay: 10
      until: k3s_service is success

    - name: Wait for K3s to be ready
      command: kubectl get nodes
      register: k3s_ready
      until: k3s_ready.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Get K3s token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token

    - name: Store token for workers
      set_fact:
        k3s_join_token: "{{ k3s_token.content | b64decode | trim }}"
        k3s_master_ip: "{{ ansible_host }}"
      delegate_facts: true
      delegate_to: localhost

    - name: Create .kube directory
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        mode: '0755'

    - name: Copy kubeconfig to user home
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: yes
        owner: "{{ ansible_user }}"
        mode: '0600'
      become: yes

- name: Install K3s on worker nodes
  hosts: workers
  become: yes
  gather_facts: no
  vars:
    k3s_agent_args: >-
      --node-label=node.kubernetes.io/role=worker
      --node-label=topology.kubernetes.io/zone=edge
      --node-label=hardware=raspberry-pi
  
  tasks:
    - name: Pre-flight connectivity check before K3s agent install
      wait_for_connection:
        timeout: 30

    - name: Check if K3s agent is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_installed

    - name: Download K3s installer script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: '0755'
        timeout: 60
      register: k3s_download
      retries: 3
      delay: 10
      until: k3s_download is success
      when: not k3s_installed.stat.exists

    - name: Install K3s agent
      shell: |
        INSTALL_K3S_VERSION={{ k3s_version }} \
        K3S_URL=https://{{ hostvars['localhost']['k3s_master_ip'] }}:6443 \
        K3S_TOKEN={{ hostvars['localhost']['k3s_join_token'] }} \
        /tmp/k3s-install.sh agent {{ k3s_agent_args }}
      when: 
        - not k3s_installed.stat.exists
        - hostvars['localhost']['k3s_join_token'] is defined
      async: 300
      poll: 15

    - name: Wait for K3s agent service to start
      systemd:
        name: k3s-agent
        state: started
      register: k3s_agent_service
      retries: 5
      delay: 10
      until: k3s_agent_service is success
      when: not k3s_installed.stat.exists

- name: Post-installation configuration
  hosts: masters[0]
  become: yes
  gather_facts: no
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  
  tasks:
    - name: Final connectivity check
      wait_for_connection:
        timeout: 30

    - name: Wait for all nodes to be ready
      command: kubectl wait --for=condition=Ready nodes --all --timeout=300s
      changed_when: false
      register: nodes_ready
      retries: 3
      delay: 30
      until: nodes_ready is success

    - name: Install Helm
      shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm
      register: helm_install
      retries: 3
      delay: 10
      until: helm_install is success or helm_install is skipped

    - name: Create namespaces
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ item }}"
      loop:
        - home-assistant
        - monitoring
        - velero
      register: ns_create
      retries: 3
      delay: 5
      until: ns_create is success

    - name: Display cluster status
      command: kubectl get nodes -o wide
      register: cluster_status
      changed_when: false

    - name: Show cluster status
      debug:
        var: cluster_status.stdout_lines

    - name: Final health verification
      debug:
        msg: |
          ============================================
          K3s CLUSTER INSTALLATION COMPLETE
          ============================================
          All nodes are ready and namespaces created.
          Kubeconfig available at: ~/.kube/config
          ============================================
